<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>图书借阅系统</title>
    <link rel="stylesheet" type="text/css" href="../static/admin/layui/css/layui.css"
          th:href="@{/admin/layui/css/layui.css}"/>
    <link rel="stylesheet" type="text/css" href="../static/admin/css/admin.css" th:href="@{/admin/css/admin.css}"/>
</head>

<body>
<div class="page-content-wrap">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">借出用户</label>
                    <div class="layui-input-block">
                        <input type="text" name="bookname" id="username" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">书名</label>
                    <div class="layui-input-block">
                        <input type="text" name="bookname" id="bookname" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">作者</label>
                    <div class="layui-input-block">
                        <input type="text" name="auther" id="auther" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-useradmin" id="searchBorrowRecord">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="layui-card-body">
            <table class="layui-table" id="borrowRecord" lay-filter="borrowRecordTable"></table>
        </div>
    </div>
</div>

<script type="text/html" id="toolbar1">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="borrow">借阅</a>
    <shiro:hasPermission name="admin:update">
        <a class="layui-btn layui-btn-xs" lay-event="update">编辑</a>
    </shiro:hasPermission>
    <shiro:hasPermission name="admin:delete">
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
    </shiro:hasPermission>
</script>
<script type="text/html" id="toolbar2">
    <shiro:hasPermission name="admin:creat">
        <a class="layui-btn layui-btn-sm" lay-event="add">添加</a>
    </shiro:hasPermission>
    <shiro:hasPermission name="admin:delete">
        <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="deleteMany">批量删除</a>
    </shiro:hasPermission>
</script>
<script src="../static/admin/layui/layui.js" type="text/javascript" th:src="@{/admin/layui/layui.js}"></script>
<script>
    layui.use(['table', 'jquery','form','layer'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var form = layui.form;
        var layer = layui.layer;
        //table数据初始化
        table.render({
            elem: '#bookinfo',
            url: '../book/info',
            toolbar: "#toolbar2",//开启头部工具栏，并为其绑定左侧模板
            limit:5,
            limits:[1,5,10,15,20],
            cols: [
                [
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'id', title: 'ID', sort: true, fixed: 'left'},
                    {field: 'bookname', title: '书名'},
                    {field: 'auther', title: '作者'},
                    {field: 'typename', title: '类型',
                        templet: function (data) {
                            return data.bookType.typeName;
                        }
                    },
                    {field: 'introduce', title: '简介'},
                    {field: 'number', title: '库存数量'},
                    {fixed: 'right', title: '操作', toolbar: '#toolbar1'}
                ]
            ],
            page: true
        });

        //----------------toolbar2（表头工具条） 绑定----------------------
        table.on('toolbar(bookinfoTable)', function (obj) {
            //获取到table表格的id
            var checkStatus = table.checkStatus(obj.config.id);
            console.log(obj.config.id)
            if (obj.event == 'add') {

                layer.open({
                    type: 1,
                    content: $("#addBook"),
                    area: ["500px", "500px"],
                    title: '添加图书'
                })
            } else if (obj.event == 'deleteMany') {
                var array = checkStatus.data;
                if (array.length == 0) {
                    layer.msg("请至少选择一行", {icon: 5, time: 2000});
                    return;
                }
                layer.confirm("检查一下别错删哦！", {icon: 6}, function () {
                    var ids = [];
                    for (var i = 0; i < array.length; i++) {
                        ids.push(array[i].id);
                    }
                    $.ajax({
                        url: "deletebyids",
                        data: "ids=" + ids,
                        dataType: "json",
                        success: function (data) {
                            if (data.code == 0) {
                                layer.msg("删除成功", {icon: 6, time: 2000});
                                //获取当前页数
                                var currpage = $(".layui-laypage-em").next().html();
                                //删除后当前页无数据刷新需要回退一页
                                console.log(table.cache['bookinfo'].length);
                                console.log(currpage);
                                if (table.cache['bookinfo'].length == ids.length && currpage > 1) {
                                    table.reload('bookinfo', {
                                        page: {
                                            curr: currpage - 1
                                        }
                                    })
                                } else {
                                    table.reload('bookinfo')
                                }
                            } else {
                                layer.msg("删除失败", {icon: 5, time: 2000});
                            }
                        }
                    })
                })
            }
        });
        //----------------------------------------------
		//-------------------添加按钮绑定事件 start---------------------------
		form.on('submit(addSubmit)',function () {
			$.ajax({
				type:"post",
				url:"add",
				data:$("#addBook").serialize(),
				success:function (data) {
					if(data.code == 0){
						/*layer.msg("图书添加成功", {icon: 1,time:3000});*/
						$("#addBook")[0].reset();
						layer.confirm("添加成功,要退出添加界面吗？",{icon: 1},function (index) {
							layer.closeAll();
						})
						table.reload('bookinfo')
					}
				},
				dateType:"json"
			});
			return false;
		});
		//-------------------添加按钮绑定事件 end---------------------------

        //---------------search start------------------
        $("#searchBook").click(function () {
            table.reload('bookinfo',{
                url: 'search',
                where:{
                    bookname: $("#bookname").val(),
                    auther: $("#auther").val(),
                    type: $("#searchType").val()
                },
                page:{
                    curr:1 //重新从第一页开始
                }
            })
        })
        //----------------search end--------------------

        //----------------toolbar1(内容工具条) 绑定----------------------
        table.on('tool(bookinfoTable)',function (obj) {
            if(obj.event =='update'){
                $.ajax({
                    url:"selectbyid",
                    data:"id="+obj.data.id,
                    dataType:"json",
                    success:function (data) {
                        //val中填写form表单lay-Filter的值
                        form.val('updateFilter',{
                            id:data.data.id,
                            bookname:data.data.bookname,
                            auther:data.data.auther,
                            introduce:data.data.introduce,
                            type:data.data.bookType.typeCode,
                            number:data.data.number
                        })
                    }
                })
                layer.open({
                    type:1,
                    content:$("#updateBook"),
                    area:["500px","500px"],
                    title:'修改图书信息'
                })
            }else if(obj.event == 'delete'){
                layer.confirm("确定要删除吗？",{icon:5},function (index) {
                    var id = obj.data.id;
                    $.ajax({
                        url:"deletebyid",
                        dataType:"json",
                        data:"id="+id,
                        success:function (data) {
                            if(data.code == 0){
                                layer.msg("删除成功",{icon:1,time:2000});
                                //获取当前页数
                                var currpage = $(".layui-laypage-em").next().html();
                                //删除后当前页无数据刷新需要回退一页
                                console.log(table.cache['bookinfo'].length);
                                console.log(currpage);
                                if (table.cache['bookinfo'].length == 1 && currpage > 1) {
                                    table.reload('bookinfo', {
                                        page: {
                                            curr: currpage - 1
                                        }
                                    })
                                } else {
                                    table.reload('bookinfo')
                                }
                            }
                        }

                    })
                })

            }else if(obj.event == 'borrow'){
                $.ajax({
                    url:"selectbyid",
                    data:"id="+obj.data.id,
                    dataType:"json",
                    success:function (data) {
                        //val中填写form表单lay-Filter的值
                        form.val('updateFilter',{
                            id:data.data.id,
                            bookname:data.data.bookname,
                            auther:data.data.auther,
                            introduce:data.data.introduce,
                            type:data.data.bookType.typeCode,
                            number:data.data.number
                        })
                    }
                })
                layer.open({
                    type:1,
                    content:$("#updateBook"),
                    area:["500px","500px"],
                    title:'修改'
                })
            }
        })
        //----------------------------------------------

        //-------------------修改按钮绑定事件 start-------------------------
        form.on('submit(updateSubmit)',function () {
            $.ajax({
                type:"post",
                url:"updatebyid",
                data:$("#updateBook").serialize(),
                success:function (data) {
                    console.log(data)
                    if(data.code == 0){
                        layer.confirm("修改成功,要退出修改界面吗？",{icon: 1},function (index) {
                            layer.closeAll();
                        })
                        table.reload('bookinfo')
                    }
                },
                dateType:"json"
            });
            return false;
        });
    });
</script>
</body>
</html>
