<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>图书借阅系统</title>
    <link rel="stylesheet" type="text/css" href="../static/admin/layui/css/layui.css"
          th:href="@{/admin/layui/css/layui.css}"/>
    <link rel="stylesheet" type="text/css" href="../static/admin/css/admin.css" th:href="@{/admin/css/admin.css}"/>
    <link rel="stylesheet" type="text/css" href="../static/admin/css/formSelects-v4.css" th:href="@{/admin/css/formSelects-v4.css}"/>
</head>

<body>
<div class="page-content-wrap">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-block">
                        <input type="text" name="username" id="username" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">用户邮箱</label>
                    <div class="layui-input-block">
                        <input type="text" name="email" id="email" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">是否锁定</label>
                    <div class="layui-input-block">
                        <select name="locked" id="locked">
                            <option value="">请选择状态</option>
                            <option value="true">是</option>
                            <option value="false">否</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-useradmin" id="searchUser">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="layui-card-body">
            <table class="layui-table" id="userlist" lay-filter="userlistTable"></table>
        </div>
    </div>
</div>
<!---------------------添加用户表格 start------------------------------->
<form class="layui-form" id="addUser" style="display: none;padding: 20px 30px 0 0" lay-filter="insertFilter">
    <div class="layui-form-item">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-inline">
            <input type="text" name="username" placeholder="请输入用户名"  lay-verify="required" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱</label>
        <div class="layui-input-inline">
            <input type="text" name="email" placeholder="输入邮箱" lay-verify="required|email" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">分配角色</label>
        <div class="layui-input-inline">
            <select name="roles" id="roles" xm-select="roles" lay-verify="required">
                <option value="">请选择角色</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addSubmit">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
<!---------------------添加用户表格 end------------------------------->

<!---------------------修改用户表格 start------------------------------->
<form class="layui-form" id="updateUser" style="display: none;padding: 20px 30px 0 0" lay-filter="updateFilter">
    <div class="layui-form-item" hidden>
        <label class="layui-form-label">ID</label>
        <div class="layui-input-inline">
            <input type="text" name="id" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-inline">
            <input type="text" name="username" placeholder="请输入用户名"  lay-verify="required" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱</label>
        <div class="layui-input-inline">
            <input type="text" name="email" placeholder="输入邮箱" lay-verify="required|email" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">是否锁定</label>
        <div class="layui-input-inline">
            <input type="checkbox" name="locked" id="updateLocked" lay-skin="switch" lay-text="是|否">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">分配角色</label>
        <div class="layui-input-inline">
            <select name="roles" xm-select="updateRoles" lay-verify="required">
                <option value="">请选择角色</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateSubmit">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
<!---------------------修改用户表格 end------------------------------->

<script type="text/html" id="toolbar1">
    <a shiro:hasPermission="admin:creat" class="layui-btn layui-btn-sm" lay-event="add">添加</a>
</script>
<script type="text/html" id="toolbar2">
    <a shiro:hasPermission="admin:update" class="layui-btn layui-btn-sm" lay-event="update">编辑</a>
</script>
<script src="../static/admin/layui/layui.js" type="text/javascript" th:src="@{/admin/layui/layui.js}"></script>
<script src="../static/admin/js/module/formSelects-v4.js" type="text/javascript" th:src="@{/admin/js/module/formSelects-v4.js}"></script>
<script>
    layui.config({
        base: '../bookmanage/admin/js/module/'
    }).extend({
        formSelects: 'formSelects-v4',
    });

    layui.use(['table', 'jquery','form','layer','formSelects'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var form = layui.form;
        var layer = layui.layer;
        var formSelects = layui.formSelects;
        //查询并给角色下拉框赋值
        $.ajax({
            url: '../role/getroles',
            dataType: 'json',
            type: 'get',
            success: function (data) {
                var roles = [];
                $.each(data.data,function (index,value) {
                    roles.push({name:value.roleName,value:value.role});
                })
                formSelects.data('roles','local',{arr:roles});
                formSelects.data('updateRoles','local',{arr:roles});
            }
        });
        //table数据初始化
        table.render({
            elem: '#userlist',
            url: '../user/info',
            toolbar: "#toolbar1",//开启头部工具栏，并为其绑定左侧模板
            limit:5,
            limits:[1,5,10,15,20],
            cols: [
                [
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'id', title: 'ID', sort: true, fixed: 'left'},
                    {field: 'username', title: '用户名'},
                    {field: 'email', title: '用户邮箱'},
                    {field: 'locked', title: '是否锁定',
                        templet:function (data) {
                            if(data.locked){
                                return "<span class='layui-badge layui-bg-gray'>是</span>";
                            }else{
                                return  "<span class='layui-badge layui-bg-green'>否</span>";
                            }
                        }
                    },
                    {field: 'createAt', title: '创建时间',
                        templet: function (data) {
                            return data.createAt.replace('T',' ');
                        }
                    },
                    {field: 'roles', title: '拥有角色',
                        templet:function (data) {
                            var roles = [];
                            $.each(data.roles,function(index,item){
                                roles.push(item.role);
                            })
                            return roles.toString();
                        }
                    },
                    {fixed: 'right', title: '操作', toolbar: '#toolbar2'}
                ]
            ],
            page: true
        });

        //----------------toolbar1（表头工具条） 绑定----------------------
        table.on('toolbar(userlistTable)', function (obj) {
            //获取到table表格的id
            var checkStatus = table.checkStatus(obj.config.id);
            if (obj.event == 'add') {
                layer.open({
                    type: 1,
                    content: $("#addUser"),
                    area: ["500px", "500px"],
                    title: '添加用户'
                })
            }
        });
        //----------------------------------------------

        //---------------search start------------------
        $("#searchUser").click(function () {
            table.reload('userlist',{
                url: 'search',
                where:{
                    bookname: $("#username").val(),
                    email: $("#email").val(),
                    locked: $("#locked").val()
                },
                page:{
                    curr:1 //重新从第一页开始
                }
            })
        })
        //----------------search end--------------------

        //----------------toolbar2(内容工具条) 绑定----------------------
        table.on('tool(userlistTable)',function (obj) {
            if(obj.event =='update'){
                $.ajax({
                    url:"selectbyid",
                    data:"id="+obj.data.id,
                    dataType:"json",
                    success:function (data) {
                        //val中填写form表单lay-Filter的值
                        form.val('updateFilter',{
                            id:data.data.id,
                            username:data.data.username,
                            email:data.data.email,
                            locked:data.data.locked
                        })
                        if(data.data.locked){
                            $("#updateLocked").prop("checked",true);
                        }else {
                            $("#updateLocked").prop("checked",false);
                        }
                        //获取对象列表的某个属性生成数组
                        var roles = data.data.roles.map(function(item) {
                            return item.role;
                        });
                        console.log(roles);
                        // 选中value为roles中的option
                        formSelects.value('updateRoles', roles);
                    }
                })
                layer.open({
                    type:1,
                    content:$("#updateUser"),
                    area:["500px","500px"],
                    title:'修改用户信息'
                })
            }
        })
        //----------------------------------------------

        //-------------------添加按钮绑定事件 start---------------------------
        form.on('submit(addSubmit)',function () {
            $.ajax({
                type:"post",
                url:"add",
                data:$("#addUser").serialize(),
                success:function (data) {
                    if(data.code == 0){
                        $("#addUser")[0].reset();
                        layer.confirm("添加成功,要退出添加界面吗？",{icon: 1},function (index) {
                            layer.closeAll();
                        })
                        table.reload('userlist')
                    }else {
                        layer.msg(data.msg,{icon:5,time:3000});
                    }
                },
                dateType:"json"
            });
            return false;
        });
        //-------------------添加按钮绑定事件 end---------------------------

        //-------------------修改按钮绑定事件 start-------------------------
        form.on('submit(updateSubmit)',function () {
            $.ajax({
                type:"post",
                url:"update",
                data:$("#updateUser").serialize(),
                success:function (data) {
                    if(data.code == 0){
                        layer.confirm("修改成功,要退出修改界面吗？",{icon: 1},function (index) {
                            layer.closeAll();
                        })
                        table.reload('userlist')
                    }else {
                        layer.msg(data.msg,{icon:5,time:3000});
                    }
                },
                dateType:"json"
            });
            return false;
        });
    });
</script>
</body>
</html>
